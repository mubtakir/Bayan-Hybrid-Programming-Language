# دليل المطوّرين للغة بيان (Bayan Developer Guide)

هذا الدليل موجّه لمن يرغب بالمساهمة في تطوير لغة بيان نفسها (المترجم/المفسّر، النحو، المنطق الهجين، ونظام الوحدات).
يشرح معمارية النظام، مكوّناته، تدفّق التنفيذ، أين تبدأ، وكيف تضيف ميزات جديدة بأمان مع الاختبارات.

المحتويات
- لمحة سريعة: ما هي بيان؟ وما الوضع الحالي؟
- بنية المستودع
- نظرة معمارية عالية المستوى
- تدفّق التنفيذ (من النص إلى التشغيل)
- المرمّز (Lexer)
- المحلّل النحوي (Parser) وAST
- المفسّر التقليدي (Traditional Interpreter)
- نظام الأصناف والوراثة (C3 MRO + super)
- المحرّك المنطقي والمنهج الهجين (Hybrid)
- نظام الاستيراد (Modules: Bayan + Python)
- الإبلاغ عن الأخطاء (Bayan stack + code frames + ألوان اختيارية)
- تشغيل الاختبارات وكتابة حالات جديدة
- إضافة ميزة لغة جديدة: منهجية العمل خطوة بخطوة
- خارطة طريق وأفكار مستقبلية

---

## لمحة سريعة: ما هي بيان؟ وما الوضع الحالي؟
- بيان لغة هجينة تجمع البرمجة التقليدية (تعريفات، دوال، أصناف، حلقات، شروط) مع برمجة منطقية شبيهة بـ Prolog (حقائق، قواعد، استعلامات) ضمن نفس الملف/الكتلة `hybrid { ... }`.
- تدعم المعرّفات العربية واللاتينية: `[a-zA-Z_\u0600-\u06FF][a-zA-Z0-9_\u0600-\u06FF]*`.
- الوراثة المتعددة مدعومة مع ترتيب طرق C3 (MRO) و`super()` بصيغتين: `super().m(...)` و`super(m, args)`.
- نظام أخطاء متقدّم مع تتبّع Bayan stack وإطارات كود ملوّنة اختيارياً ومؤشّر ^ محسوب عرضياً (عربي/محارف واسعة/تبويبات) واقتراحات "هل تقصد؟" للأسماء غير المعروفة.
- الوضع الحالي: جميع الاختبارات القائمة ناجحة (كما في بيئة التطوير المستخدمة أثناء التوثيق). راجع tests/ للاطلاع.

## بنية المستودع
- bayan/bayan/lexer.py: المرمّز إلى رموز (Tokens) مع معلومات (line, column)
- bayan/bayan/parser.py: المحلّل وبناء شجرة AST وإرفاق الموقع بكل عقدة
- bayan/bayan/traditional_interpreter.py: المفسّر للتراكيب التقليدية + النظام الكائني + الإبلاغ عن الأخطاء
- bayan/bayan/hybrid_interpreter.py: تنسيق التنفيذ الهجين بين التقليدي والمنطقي
- bayan/bayan/logical_engine.py: التعابير المنطقية (Term, Predicate, Fact, Rule) وخوارزميات التحقق
- bayan/bayan/import_system.py (إن وجد) أو داخل المفسّر: تحميل الوحدات (ببيان وبايثون) والتخزين المؤقت
- bayan/tests/: اختبارات pytest لوحدات اللغة وسلوكها
- docs/basics.md: دليل أساسيات اللغة
- docs/reference.md: مرجع نحوي وسلوكي مختصر-رسمي

## نظرة معمارية عالية المستوى
- طبقة Lexing: تحوّل النص إلى تسلسل Tokens وتحافظ على line/column.
- طبقة Parsing: تبني AST من الـ Tokens، وتضيف metadata: (line, column, filename) لكل عقدة عبر `with_pos`.
- طبقة Interpreting:
  - تقليدية: تقييم العبارات، بيئات المتغيرات، الدوال، الأصناف، الدوال السحرية.
  - منطقية: تمثيل الحقائق والقواعد والاستعلامات وتشغيلها.
  - هجينة: دمج الطبقتين داخل كتلة واحدة، مع واجهة Interpreter عليا تجمعهما.
- طبقة الاستيراد: تحميل وحدات بيان أولاً ثم محاولة بايثون الآمنة (قوائم بحث وتخزين مؤقت).
- طبقة الأخطاء: تتبّع مكدّس عقد Bayan وإظهار code frame ذكي مع خيارات تلوين.

## تدفّق التنفيذ (من النص إلى التشغيل)
1) Lexer: إدخال نص → Tokens (مع line/column).
2) Parser: Tokens → AST (Program/Block/Statements/Expressions...) مع filename/line/column.
3) Hybrid/Traditional Interpreter: زيارة العقد حسب نوعها، إدارة بيئات التنفيذ، ودفع/سحب إطارات المكدّس.
4) عند الخطأ: تشكيل رسالة تتضمن Bayan stack + code frame حسب الموضع.

## المرمّز (Lexer)
- يتعرّف:
  - المعرّفات العربية/اللاتينية.
  - الأعداد (صحيحة/عشرية)، السلاسل النصية، `True/False/None`.
  - الكلمات: `def, class, if, elif, else, for, while, in, print, return, break, continue, pass, and, or, not, self, super, import, from, as, hybrid, query, fact, rule`.
  - العوامل: `== != <= >= < > + - * / %`, و`in` للمحددات، و`:-` أو `←` للقواعد المنطقية.
- كل Token يحمل (type, value, line, column).

## المحلّل النحوي (Parser) وAST
- يستقبل اختياريًا `filename` ويًرفقه لكل عقدة عبر `_with_pos` → `node.with_pos(line, column, filename)`.
- يدعم:
  - التعاريف: `def`, `class` (وراثة مفردة/متعددة: `class C(A,B): { ... }`).
  - الجمل: `if/elif/else`, `for`, `while`, `return`, `print`.
  - التعبيرات: أعداد، نصوص، منطقية، متغيرات (بما فيها المنطقية `?X` داخل المنطق)، قوائم `{}` وقواميس `[]` حسب الملف، الوصول، الاستدعاء، الفهرسة.
  - `self` مع سلاسل لاحقة، و`super()` بصيغتيها المذكورتين.
  - المنطق: facts/rules/queries داخل أو خارج `hybrid {}` حسب القواعد.
- AST يضم عقدًا مثل: Program, Block, Assignment, AttributeAssignment, SubscriptAssignment, IfStatement, ForLoop, WhileLoop, ReturnStatement, PrintStatement, FunctionDef, ClassDef, Number, String, Boolean, Variable, List, Dict, FunctionCall, MethodCall, AttributeAccess, SubscriptAccess, UnaryOp, BinaryOp, SelfReference, SuperCall، إضافة إلى Predicate/Fact/Rule/Query للمنطق.

## المفسّر التقليدي (Traditional Interpreter)
- بيئات:
  - `global_env` و`local_env` (المجال الحالي)، مع جداول `functions` و`classes`.
- بروتوكولات مدعومة عبر الدوال السحرية (dunder):
  - حسابية/مقارنات: `__add__`, `__sub__`, `__mul__`, `__truediv__`, `__mod__`, `__eq__`, `__ne__`, `__lt__`, `__le__`, `__gt__`, `__ge__`, وأحادي `__neg__`.
  - نصية/تمثيل: `__repr__`.
  - حقيقة وطول: `__bool__`, `__len__`.
  - حاويات: `__getitem__`, `__setitem__`, `__contains__`.
  - تكرار: `__iter__`.
  - قابلية الاستدعاء: `__call__`.
- الحقيقة (truthiness): يفضّل `__bool__`، ثم `__len__`، وإلا فالحقيقة الافتراضية.

## نظام الأصناف والوراثة (C3 MRO + super)
- الأصناف تدعم وراثة متعددة مع حساب ترتيب C3.
- استدعاء `super()`:
  - `super().method(args)`، أو الصيغة القديمة `super(method, args)`.
- المفسّر يحافظ على owner stack (السياق المالك للوسيلة) لضمان تخطّي الصنف الحالي في تسلسل MRO.

## المحرّك المنطقي والمنهج الهجين (Hybrid)
- هياكل: `Term`, `Predicate`, `Fact`, `Rule`.
- القواعد: `head(X) :- body1(X), body2(X).` أو `head(X) ← body1(X), body2(X).`
- الاستعلام: `query predicate(...)`. المتغير المنطقي يبدأ بـ `?`.
- الكتلة `hybrid { ... }`: تُدمج فيها التصريحات التقليدية مع حقائق/قواعد/استعلامات.

## نظام الاستيراد (Modules)
- صيغ:
  - `import pkg.module [as alias]`
  - `from pkg.module import Name[, Name]*`
- يحمّل وحدات بيان (`.bayan`) أولاً من مسارات محدّدة (مثل cwd وtests/ وtests/bayan_modules/ إذا كانت مهيّأة)، ثم يحاول استيراد بايثون الآمن.
- التخزين المؤقت يمنع إعادة التحميل لنفس الوحدة.
- يتم عرض محتوى الوحدة عبر Proxy يتيح الوصول إلى الأصناف/الدوال/المتغيرات التي عرّفتها الوحدة.

## الإبلاغ عن الأخطاء (Bayan stack + code frames)
- كل زيارة لعقدة تضيف إطارًا إلى `_call_stack` بصيغة `(NodeType, line, column, filename)`، ويزال بعد التقييم.
- عند التقاط خطأ، يُبنى `BayanRuntimeError` مع:
  - Bayan stack: `Node@file:line:col -> ...`
  - إطار كود (code frame) اختياري التلوين: اسم الملف، سطور سياقية مرقّمة، إبراز السطر الحالي، مؤشر `^` بمحاذاة عرضية صحيحة (يدعم تبويبات ومحارف واسعة).
- واجهات الإعداد:
  - `set_source(code, filename=None)` لتوفير النص لأطر الكود.
  - `set_error_formatting(colors: bool, context_lines: int, tabstop: int)` لتخصيص العرض.
- اقتراحات "هل تقصد؟" لأسماء غير معرّفة عبر مسافة Levenshtein قصيرة على رموز البيئة الحالية (محلي/عام + أسماء الدوال/الأصناف).

## تشغيل الاختبارات وكتابة حالات جديدة
- من مجلد bayan/: شغّل: `pytest -q`
- تشغيل ملف واحد: `pytest -q tests/test_error_reporting.py`
- تشغيل اختبار مسمّى: `pytest -q -k name_substring`
- إضافة اختبار:
  - ضع ملفًا في tests/ يبدأ بـ `test_*.py`.
  - أنشئ حالات إيجابية/سلبية تغطي السلوك الجديد ومواضع الخطأ وحدود الحالات.

## إضافة ميزة لغة جديدة: منهجية العمل خطوة بخطوة
1) حدّد المتطلبات بدقة وأضف اختبارات أولًا (TDD إن أمكن).
2) Lexer:
   - إن كانت الميزة تتطلب رمزًا/كلمة محجوزة جديدة، أضف TokenType والقواعد.
3) Parser:
   - حدّث القواعد، وأعد استخدام `_with_pos` لكل عقدة تُنشِئها.
   - راعِ تداخل السلاسل (الوصول/الفهرسة/الاستدعاء) وملكية الموضع (token الأنسب).
4) Interpreter:
   - أضف زائر العقدة الجديدة وممنهجية تقييمها.
   - إن كانت علاقة بمشغّلات/dunder فادمجها مع المنطق القائم بحذر.
5) التوثيق:
   - حدّث docs/basics.md وdocs/reference.md بما يعكس السلوك الجديد.
6) التحقّق:
   - شغّل اختبارات الملف المعني ثم المجموعة كاملة.

## خارطة طريق وأفكار مستقبلية
- اللغة:
  - وسائط افتراضية ومعاملات مسماة للـ functions.
  - سلاسل نصية متعددة الأسطر وهروب محارف موسّع.
  - استثناءات مخصّصة (raise/try/except) ومزيد من أنواع الأخطاء الدلالية.
  - تحسين التكامل مع بايثون (Typed interop، تحويلات أنواع آمنة).
- الأدوات:
  - تنسيق تلقائي للشفرة وتحقق ساكن (lint/type-check) إن تقرّر.
  - قناة REPL تفاعلية مع إبراز نحوي وتكامل الألوان.
- تشخيص الأخطاء:
  - سياق أسطر متعدد قابل للتهيئة عالميًا.
  - اقتراحات أغنى (spellcheck متعدد اللغات، اقتراح استيراد مفقود).

## من أين أبدأ؟
- اقرأ docs/basics.md وdocs/reference.md لتفهم السلوك الحالي.
- شغّل الاختبارات بـ `pytest -q` للتأكد من صحة البيئة.
- جرّب تعديلًا صغيرًا (على سبيل المثال تحسين رسالة خطأ) وأضف اختبارًا له.
- عند إضافة نحو جديد: ابدأ من lexer → parser → interpreter → tests → docs.

انتهى.

